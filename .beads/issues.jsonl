{"id":"pnt-3qp","title":"Investigate and validate optimal test strategy for PyO3 + Python hybrid packages","description":"The current devShell excludes pnt-cli from uv2nix editableOverlay because maturin packages are incompatible with pyprojectFixupEditableHook (expects EDITABLE_ROOT which maturin does not set). This means nix develop -c pytest cannot import pnt_cli._native, failing both locally and in CI.\n\nThis task requires investigation and experimentation to determine the optimal testing strategy for packages containing both Python and Rust code via PyO3 extension modules, using maturin as the build backend and crane for Rust build artifact caching.\n\nQuestions to answer through experimentation:\n\n1. Can we install pnt-cli non-editable in the devShell virtualenv (pre-built wheel via Nix) so pytest can import _native? What are the trade-offs for developer iteration speed?\n\n2. What is the correct split between cargo nextest (pure Rust unit tests in crates/) and pytest (Python integration tests that exercise the PyO3 bindings)? Should these be separate CI jobs or a unified test recipe?\n\n3. Can maturin develop be integrated into the devShell shellHook or a just recipe to build the extension in-place for iterative development? How does this interact with the uv2nix virtualenv?\n\n4. How do the reference implementations handle this?\n   - ~/projects/nix-workspace/uv2nix — upstream patterns for maturin/PyO3 packages\n   - ~/projects/nix-workspace/pyproject.nix — Python project tooling for Nix\n   - ~/projects/nix-workspace/nix-cargo-crane — crane patterns for Rust builds\n   - ~/projects/rust-workspace/ironstar — crane devShell integration (Rust-only but relevant caching patterns)\n\n5. For the template test (omnix init + validate): should instantiated templates use nix flake check (builds everything through Nix including maturin wheel), nix develop -c uv run pytest (uv builds the wheel), or a combination?\n\n6. Does the nix build path (nix flake check / nix build) already exercise both Rust compilation (via crane cargoArtifacts) and Python tests (via pytest in check phase)? If so, it may be sufficient for CI validation without needing devShell-based testing.\n\nAcceptance criteria:\n- Document the chosen test strategy with rationale\n- Validate that both cargo nextest (Rust unit tests) and pytest (Python integration tests) pass\n- Validate the strategy works both locally (nix develop) and in CI (template instantiation test)\n- Update devshell.nix, justfile, and template.yaml as needed to implement the chosen strategy\n- Ensure crane artifact caching is preserved (no unnecessary Rust rebuilds)","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-02-03T10:20:11.038346-05:00","created_by":"Cameron Smith","updated_at":"2026-02-03T11:07:51.054773-05:00","closed_at":"2026-02-03T11:07:51.054773-05:00","close_reason":"Resolved via test relocation: pnt-cli tests moved from src/pnt_cli/tests/ to tests/ (outside source namespace). This avoids source tree shadowing the installed wheel with _native.so. Strategy: Rust tests via cargo nextest (devShell + crane checks), Python tests via pytest from package dir (installed wheel). maturin develop not needed. nix flake check validates both build paths.","dependencies":[{"issue_id":"pnt-3qp","depends_on_id":"pnt-edl","type":"child-of","created_at":"2026-02-03T10:20:20.918483-05:00","created_by":"Cameron Smith"},{"issue_id":"pnt-3qp","depends_on_id":"pnt-j6f","type":"blocked-by","created_at":"2026-02-03T10:20:21.103095-05:00","created_by":"Cameron Smith"}]}
{"id":"pnt-4jg","title":"Dependency model migration","description":"Migrate from single-lock uv workspace to independent-lock multi-package pattern following langchain/langgraph approach. Include pixi feature-based composition for conda ecosystem parity.","status":"closed","priority":2,"issue_type":"epic","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:54:40.744055-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T15:37:43.167289-05:00","closed_at":"2026-02-02T15:37:43.167289-05:00","close_reason":"All children closed: pnt-4jg.1 (uv workspace removal), pnt-4jg.2 (pixi feature composition), pnt-4jg.3 (distribution channel docs). Dependency model migration complete."}
{"id":"pnt-4jg.1","title":"Remove uv workspace, adopt path dependencies","description":"Remove [tool.uv.workspace] from root pyproject.toml. Each package gets own pyproject.toml with [tool.uv.sources] for sibling references using path sources with editable=true. Follow langchain pattern.","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:55:07.344057-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T14:40:02.175394-05:00","closed_at":"2026-02-02T14:40:02.175394-05:00","close_reason":"Implemented in a8a823f. Removed root uv workspace, generated per-package locks, rewrote nix modules to Pattern 3 per-package loading.","dependencies":[{"issue_id":"pnt-4jg.1","depends_on_id":"pnt-4jg","type":"parent-child","created_at":"2026-01-19T11:55:07.344659-05:00","created_by":"Cameron Smith"}],"comments":[{"id":1,"issue_id":"pnt-4jg.1","author":"Cameron Smith","text":"Post-close fixup commits (774ec26):\n- fix(ci): update lock file references for per-package federation (d0cab2a)\n- fixup! merge federated workspace deps: replace // with zipAttrsWith for extras-safe dep merging (7b3e7ae)\n- fixup! load packages independently: document version-conflict invariant in python.nix and architecture doc (36eb8a7, 774ec26)\n\nReview findings addressed: stale CI cache-dependency-glob paths, fragile shallow-merge dep specs, undocumented overlay composition invariant. Full CI redesign (nix develop + justfile symmetry) deferred to pnt-dre.4.","created_at":"2026-02-02T20:17:00Z"}]}
{"id":"pnt-4jg.2","title":"Configure pixi feature-based composition","description":"Implement pixi feature/environment pattern: [feature.X.dependencies] + [environments] composition. Single pixi.lock covering all environments. Per-feature task definitions. Target-specific dependencies for platform support.","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:55:08.085592-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T15:36:49.459815-05:00","closed_at":"2026-02-02T15:36:49.459815-05:00","close_reason":"Verified pixi feature composition via nix develop -c just \u003crecipe\u003e. Fixed: added missing feature tasks to python-nix-template, delegated justfile conda recipes to pixi task names for correct working directory, moved deprecated build channels to backend.channels.","dependencies":[{"issue_id":"pnt-4jg.2","depends_on_id":"pnt-4jg","type":"parent-child","created_at":"2026-01-19T11:55:08.086155-05:00","created_by":"Cameron Smith"}]}
{"id":"pnt-4jg.3","title":"Document package distribution channels","description":"Document which packages support uv/pypi vs pixi/conda distribution. Note dependency graph differences between channels. Update README and package metadata.","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:55:09.051203-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T15:37:38.374454-05:00","closed_at":"2026-02-02T15:37:38.374454-05:00","close_reason":"Documented in docs/notes/architecture/package-distribution-channels.md. Both packages support dual-channel (uv/PyPI + pixi/conda-forge) with independent locks. No blocking dependency graph differences between channels.","dependencies":[{"issue_id":"pnt-4jg.3","depends_on_id":"pnt-4jg","type":"parent-child","created_at":"2026-01-19T11:55:09.051857-05:00","created_by":"Cameron Smith"},{"issue_id":"pnt-4jg.3","depends_on_id":"pnt-4jg.1","type":"blocks","created_at":"2026-01-19T12:20:13.557576-05:00","created_by":"Cameron Smith"},{"issue_id":"pnt-4jg.3","depends_on_id":"pnt-4jg.2","type":"blocks","created_at":"2026-01-19T12:20:16.147971-05:00","created_by":"Cameron Smith"}]}
{"id":"pnt-5vr","title":"Add production containers via nix2container and replace flocken tooling","description":"Add lightweight production/execution container images using nix2container (vanixiets pattern) and replace flocken manifest tooling. This does NOT touch nixpod-based dev containers.\n\nProduction containers (new):\n- nix2container.buildImage for minimal per-package execution images\n- Each user-facing package gets a container with only its runtime closure\n- pkgsCross for cross-compilation (eliminates QEMU dependency)\n- Per-container layer strategy: base layer (bash, coreutils) + app layer\n\nFlocken replacement (affects all containers):\n- crane-based mkMultiArchManifest replacing flocken mkDockerManifest\n- skopeo-nix2container with nix: transport for pushing\n- containerMatrix flake output for CI matrix generation (pure nix evaluation)\n- build-nix-images.yaml updated for nix2container workflow\n\nDoes NOT include:\n- Dev container migration (see pnt-xxx blocked issue)\n- Changes to buildMultiUserNixImage or nixpod integration\n- Existing dev container content or architecture\n\nReference: ~/projects/nix-workspace/vanixiets/modules/containers/default.nix\nReference: ~/projects/nix-workspace/vanixiets/lib/mk-multi-arch-manifest.nix\n\nAcceptance criteria:\n- nix2container flake input added\n- At least one production container defined via nix2container.buildImage\n- pkgsCross used for cross-compilation targets\n- lib/mk-multi-arch-manifest.nix ported from vanixiets\n- containerMatrix flake output for CI matrix generation\n- flocken replaced by crane-based manifests for production containers\n- Existing dev containers still build and work (no regression)","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-02-02T20:24:12.624117-05:00","created_by":"Cameron Smith","updated_at":"2026-02-03T00:32:32.102656-05:00","closed_at":"2026-02-03T00:32:32.102656-05:00","close_reason":"Implemented in c760bd1. PR #44.","comments":[{"id":3,"issue_id":"pnt-5vr","author":"Cameron Smith","text":"Checkpoint: session 2026-02-02\n\nDone:\n- Researched vanixiets nix2container patterns (containers/default.nix, mk-multi-arch-manifest.nix, containers.yaml workflow)\n- Researched current pnt container infrastructure (containers.nix, build-nix-image action, build-nix-images workflow)\n- Identified scope mismatch between vanixiets lightweight tool containers and pnt dev containers\n- Rescoped to production containers + flocken replacement only (dev containers deferred to pnt-mgq)\n\nRemaining:\n- Add nix2container flake input\n- Create lib/mk-multi-arch-manifest.nix (port from vanixiets)\n- Define at least one production container via nix2container.buildImage (pnt-cli is the natural candidate)\n- Add pkgsCross targets and containerMatrix flake output\n- Replace flocken manifest tooling for existing dev containers (crane-based manifests)\n- Update build-nix-images.yaml workflow\n- Update build-nix-image composite action (QEMU no longer needed for production containers)\n- Add justfile recipes for container build/push (local/CI symmetry)\n\nContext for next agent:\n- vanixiets reference files are fully analyzed, see subagent outputs in this session\n- setup-nix action is already deployed on this branch stack (pnt-m3t-setup-nix merged into branch)\n- build-nix-image action already had redundant Nix install removed\n- Branch is pnt-5vr-nix2container, branched off pnt-m3t-setup-nix tip\n- Dev containers MUST NOT be touched — only production containers and manifest tooling","created_at":"2026-02-03T02:52:29Z"},{"id":4,"issue_id":"pnt-5vr","author":"Cameron Smith","text":"Checkpoint: session 2026-02-02 (continued)\n\nCompleted:\n- Added nix2container flake input, removed flocken as direct input\n- Created nix/lib/mk-multi-arch-manifest.nix (ported from vanixiets, generalized with mkSourceUri for mixed transport)\n- Added minimal CLI entrypoint to pnt-cli (main() exercising pyo3 greet/add bindings)\n- Defined pnt-cli production container via nix2container.buildImage with 2-layer strategy\n- Replaced flocken manifests with crane-based manifests for all containers (production: nix: transport, dev: docker-archive: transport)\n- Added containerMatrix flake output for CI matrix generation\n- Refactored build-nix-images.yaml to 3-job pattern (discover/build/manifest)\n- Removed obsolete build-nix-image composite action\n- Updated ci.yaml and package-release.yaml callers\n- Added justfile container recipes (build/load/push for production and dev, matrix display)\n\nKnown limitations:\n- Production containers built natively per-system (not pkgsCross) due to Python + maturin + Cargo cross-compilation complexity\n- docker-archive: transport for dev container manifests not yet tested against crane index append (may need validation)\n- Dev containers in CI still limited to x86_64-linux only (NIX_IMAGE_SYSTEMS override)\n\nRemaining for verification:\n- Linux builder needed to test actual container image builds (nix build .#pnt-cliProductionImage)\n- CI workflow run to validate end-to-end (discover -\u003e build -\u003e manifest push)\n- Verify docker-archive: transport works with skopeo + crane manifest list creation","created_at":"2026-02-03T03:52:51Z"},{"id":5,"issue_id":"pnt-5vr","author":"Cameron Smith","text":"Checkpoint: session 2026-02-02 (CI refactoring)\n\nDone:\n- Fixed template test failure: added [project] and [tool.uv.workspace] to root pyproject.toml\n- Simplified template.yaml: replaced GitGuardian with setup-nix action, removed scan/set-variables jobs\n- Created scripts/ci/ci-build-category.sh for category-based matrix builds\n- Added justfile recipes: ci-build-category, scan-secrets, scan-staged, preview-version, release-package\n- Added gitleaks to devshell for local/CI parity\n- Refactored ci.yaml: replaced omnix/nixci with 3-entry category matrix (packages, checks, devshells), replaced GitGuardian with gitleaks via nix develop, added flake-validation and bootstrap-verification jobs, added preview-release-version job, reduced top-level permissions to contents:read\n- Refactored package-release.yaml: replaced setup-uv and setup-yarn actions with nix develop via setup-nix, added cached-ci-job support, fixed artifact upload path\n- Fixed permissions chain: build-nix-images.yaml needs packages:write from callers, added to build-pr-images and test-release-packages\n\nRemaining:\n- CI run verification: latest push (4bc84a3) should resolve startup_failure from permissions chain. Need to verify CI passes end-to-end.\n- Iterative fixes: if nix category builds or test-release-packages fail at runtime, diagnose from logs and fix\n- Close pnt-5vr once CI confirmed working\n- Container workflow 3-job pattern (discover -\u003e build -\u003e manifest) not yet tested in CI\n\nContext for next agent:\n- Branch is pnt-5vr-nix2container with PR #44\n- The CI architecture now matches vanixiets/typescript-nix-template patterns\n- Three parallel startup_failures were caused by permissions chain issues (build-nix-images.yaml declares packages:write at workflow level, GitHub validates entire call chain at parse time)\n- run 21617100530 was from an intermediate push before the full refactoring landed\n- The secrets-scan job uses nix develop -c just scan-secrets (gitleaks is in devshell)\n- The nix job uses a static 3-entry matrix calling just ci-build-category\n- package-release.yaml now uses nix develop for all tool access (yarn, uv)\n- To check CI: gh run list --workflow \"CI/CD\" --limit 3 --repo sciexp/python-nix-template\n- To download logs: gh api \"repos/sciexp/python-nix-template/actions/runs/\u003cid\u003e/logs\" \u003e logs.zip","created_at":"2026-02-03T04:45:03Z"}]}
{"id":"pnt-btz","title":"pyo3/Rust extension integration","description":"Add Rust extension module support via maturin + pyo3, demonstrating Nix build integration with crane cargoArtifacts sharing and uv2nix overlay composition.\n\nArchitecture documented in: docs/notes/architecture/crane-uv2nix-integration.md\n\nKey patterns:\n- Per-package Rust workspace (crates/ inside Python package)\n- crane buildDepsOnly for artifact caching\n- uv2nix overlay injection for maturin builds\n- CI matrix with rust-deps/rust-checks/python-wheel categories\n\nReference implementations:\n- ~/projects/rust-workspace/ironstar (crane patterns)\n- ~/projects/planning-workspace/langchain (federated Python)\n","status":"closed","priority":2,"issue_type":"epic","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:54:41.426256-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T20:45:01.187149-05:00","closed_at":"2026-02-02T20:45:01.187149-05:00","close_reason":"All 3 children complete. Crane + uv2nix + maturin integration fully operational.","dependencies":[{"issue_id":"pnt-btz","depends_on_id":"pnt-dre","type":"blocks","created_at":"2026-01-19T11:55:32.690895-05:00","created_by":"Cameron Smith"},{"issue_id":"pnt-btz","depends_on_id":"pnt-4jg","type":"blocks","created_at":"2026-01-19T11:55:32.812602-05:00","created_by":"Cameron Smith"}]}
{"id":"pnt-btz.1","title":"Create pnt-cli package scaffold with Rust crates","description":"Create packages/pnt-cli/ with federated structure:\n\nDirectory structure:\n- packages/pnt-cli/pyproject.toml (maturin build-backend, manifest-path binding)\n- packages/pnt-cli/src/pnt_cli/__init__.py (Python wrapper)\n- packages/pnt-cli/crates/Cargo.toml ([workspace] with member crates)\n- packages/pnt-cli/crates/pnt-cli-core/Cargo.toml (pure Rust library)\n- packages/pnt-cli/crates/pnt-cli-py/Cargo.toml (pyo3 bindings, depends on core)\n\npyproject.toml configuration:\n- [build-system] requires maturin\u003e=1.5\n- [tool.maturin] manifest-path = \"crates/pnt-cli-py/Cargo.toml\"\n- [tool.maturin] module-name = \"pnt_cli._native\"\n\nMinimal proof-of-concept: expose a simple function from Rust to Python.\n\nSee: docs/notes/architecture/crane-uv2nix-integration.md\n","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:55:17.885691-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T20:30:16.311977-05:00","closed_at":"2026-02-02T20:30:16.311977-05:00","close_reason":"Implemented in a3e79c3. Scaffold verified: cargo check, cargo test (2/2 pass), cargo clippy clean.","dependencies":[{"issue_id":"pnt-btz.1","depends_on_id":"pnt-btz","type":"parent-child","created_at":"2026-01-19T11:55:17.886287-05:00","created_by":"Cameron Smith"},{"issue_id":"pnt-btz.1","depends_on_id":"pnt-4jg.1","type":"blocks","created_at":"2026-01-19T12:20:18.940008-05:00","created_by":"Cameron Smith"}]}
{"id":"pnt-btz.2","title":"Implement crane + uv2nix Nix modules","description":"Create Nix modules implementing the crane + uv2nix integration pattern.\n\nFiles to create:\n- nix/packages/pnt-cli/rust.nix (crane configuration)\n- nix/packages/pnt-cli/default.nix (Python + Rust composition)\n- nix/modules/rust/lib.nix (shared crane utilities, optional)\n\nrust.nix pattern:\n- crane-lib.buildDepsOnly for cargoArtifacts caching\n- commonArgs pattern for derivation hash consistency\n- crane-lib.vendorCargoDeps for maturin's cargo invocation\n- Export cargoArtifacts, cargoVendorDir, clippy, nextest\n\ndefault.nix pattern:\n- Import rust.nix\n- Create overlay injecting cargoVendorDir and CARGO_TARGET_DIR\n- Export overlay and checks for flake composition\n\nUpdate nix/modules/python.nix:\n- Load pnt-cli workspace independently (federated pattern)\n- Compose Rust overlay with uv2nix overlays\n\nSee: docs/notes/architecture/crane-uv2nix-integration.md\n","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:55:18.885252-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T20:41:16.274515-05:00","closed_at":"2026-02-02T20:41:16.274515-05:00","close_reason":"Implemented in 8d8a814. Crane checks (clippy, nextest) build. Full maturin wheel builds via nix build .#default. Python import verified: greet('nix') and add(2,3) work end-to-end.","dependencies":[{"issue_id":"pnt-btz.2","depends_on_id":"pnt-btz","type":"parent-child","created_at":"2026-01-19T11:55:18.885818-05:00","created_by":"Cameron Smith"},{"issue_id":"pnt-btz.2","depends_on_id":"pnt-btz.1","type":"blocks","created_at":"2026-01-19T12:20:08.210077-05:00","created_by":"Cameron Smith"}]}
{"id":"pnt-btz.3","title":"Validate integration and update CI","description":"Validate the full crane + uv2nix + maturin integration and update CI.\n\nValidation checklist:\n- [ ] nix build .#pnt-cli produces working wheel\n- [ ] Python import succeeds: from pnt_cli._native import ...\n- [ ] Rust changes trigger minimal rebuilds (cargoArtifacts cached)\n- [ ] Python-only changes don't rebuild Rust\n- [ ] cargoClippy and cargoNextest checks pass\n\nCI updates (.github/workflows/ci.yaml):\n- Add rust-deps matrix category for cargoArtifacts caching\n- Add rust-checks matrix category for clippy/nextest\n- Ensure proper cache key based on Cargo.lock hash\n- Follow ironstar CI matrix pattern\n\nDocumentation updates:\n- Add usage example to README\n- Document development workflow (uv sync + maturin develop vs nix build)\n- Note editable install limitations\n\nSee: docs/notes/architecture/crane-uv2nix-integration.md\n","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:55:19.746622-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T20:44:56.18025-05:00","closed_at":"2026-02-02T20:44:56.18025-05:00","close_reason":"Validated in 1b7b12e. All acceptance criteria pass: nix build produces working wheel, Python import succeeds, clippy/nextest checks pass, justfile recipes work via nix develop -c. CI updated with Rust path filters and hash-sources.","dependencies":[{"issue_id":"pnt-btz.3","depends_on_id":"pnt-btz","type":"parent-child","created_at":"2026-01-19T11:55:19.74722-05:00","created_by":"Cameron Smith"},{"issue_id":"pnt-btz.3","depends_on_id":"pnt-btz.2","type":"blocks","created_at":"2026-01-19T12:20:11.013516-05:00","created_by":"Cameron Smith"}]}
{"id":"pnt-dre","title":"Infrastructure alignment","description":"Align Makefile, justfile, scripts/, and CI with vanixiets and typescript-nix-template patterns. Makefile bootstrap-only, grouped justfile recipes, cached-ci-job CI pattern, omnix template integration.","status":"closed","priority":2,"issue_type":"epic","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:54:39.841346-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T15:56:26.823947-05:00","closed_at":"2026-02-02T15:56:26.823947-05:00","close_reason":"All children closed: pnt-dre.1 (Makefile), pnt-dre.2 (justfile), pnt-dre.3 (scripts), pnt-dre.4 (cached-ci-job/CI), pnt-dre.5 (omnix template). Infrastructure alignment complete."}
{"id":"pnt-dre.1","title":"Refactor Makefile to bootstrap-only pattern","description":"Restrict Makefile to bootstrap targets only: install-nix, install-direnv, verify, setup-user, check-secrets, clean. Move all other targets to justfile.","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:54:54.237851-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T15:39:45.088007-05:00","closed_at":"2026-02-02T15:39:45.088007-05:00","close_reason":"Added verify, setup-user, check-secrets targets aligned with vanixiets. Updated bootstrap output with numbered next-steps. Makefile was already bootstrap-only; no targets removed.","dependencies":[{"issue_id":"pnt-dre.1","depends_on_id":"pnt-dre","type":"parent-child","created_at":"2026-01-19T11:54:54.238477-05:00","created_by":"Cameron Smith"}]}
{"id":"pnt-dre.2","title":"Adopt grouped justfile recipe pattern","description":"Reorganize justfile with grouped recipes and section headers following vanixiets pattern: nix, python, conda, docs, secrets, ci/cd groups. Add help comments for each recipe.","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:54:55.145094-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T15:42:24.899403-05:00","closed_at":"2026-02-02T15:42:24.899403-05:00","close_reason":"Aligned group naming (conda package→conda, python package→python), fixed Documentation→Docs header, demoted GCP sub-section, corrected type recipe comment, moved helper to EOF.","dependencies":[{"issue_id":"pnt-dre.2","depends_on_id":"pnt-dre","type":"parent-child","created_at":"2026-01-19T11:54:55.145764-05:00","created_by":"Cameron Smith"}]}
{"id":"pnt-dre.3","title":"Reorganize scripts/ directory structure","description":"Move scripts into subdirectories: scripts/ci/, scripts/docs/, scripts/sops/. IMPORTANT: scripts/bootstrap.sh must remain at stable path for curl one-liner URL. Update justfile and CI references.","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:54:55.839371-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T15:45:23.076616-05:00","closed_at":"2026-02-02T15:45:23.076616-05:00","close_reason":"Created scripts/bootstrap.sh (stable URL for curl one-liner) and scripts/ci/maximize-build-space.sh (canonical version of duplicated CI logic). Workflow inline references deferred to pnt-dre.4 CI redesign due to pre-checkout step ordering. scripts/sops/ and scripts/docs/ skipped — no duplication issues warranting extraction.","dependencies":[{"issue_id":"pnt-dre.3","depends_on_id":"pnt-dre","type":"parent-child","created_at":"2026-01-19T11:54:55.839951-05:00","created_by":"Cameron Smith"}]}
{"id":"pnt-dre.4","title":"Implement cached-ci-job composite action pattern","description":"Add .github/actions/cached-ci-job composite action following typescript-nix-template pattern. Content-addressed caching with hash-sources and force-run support. Update CI to use category-based matrix builds.\n\nPost-federation CI adaptation: the migration from uv workspace to per-package independent locks (pnt-4jg.1) means CI must now discover and iterate packages under packages/. The matrix strategy needs a package axis in addition to the category axis, producing either a {package} x {category} matrix or per-package reusable workflow dispatches. Review how ci.yaml currently enumerates packages and ensure the composite action pattern supports per-package resolution of lock files, dependency caches, and build artifacts.\n\nAcceptance criteria:\n- .github/actions/cached-ci-job composite action implemented\n- Content-addressed caching with hash-sources and force-run support\n- CI matrix discovers packages/ dynamically (not hardcoded)\n- Matrix crosses package x category dimensions\n- Per-package uv.lock files used for cache keys (not root lock)\n- Category-based builds follow typescript-nix-template pattern","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:54:56.79376-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T15:55:30.748155-05:00","closed_at":"2026-02-02T15:55:30.748155-05:00","close_reason":"Implemented cached-ci-job composite action (ported from typescript-nix-template), per-package CI justfile recipes (ci-sync, ci-lint, ci-test, ci-typecheck, ci-check, list-packages-json), rewrote python-test.yaml to use nix develop -c just \u003crecipe\u003e, added dynamic package discovery and force_run to ci.yaml. All CI steps expressible as nix develop -c just \u003crecipe\u003e.","dependencies":[{"issue_id":"pnt-dre.4","depends_on_id":"pnt-dre","type":"parent-child","created_at":"2026-01-19T11:54:56.794334-05:00","created_by":"Cameron Smith"}],"comments":[{"id":2,"issue_id":"pnt-dre.4","author":"Cameron Smith","text":"Minimal CI path fixes applied in d0cab2a as part of pnt-4jg.1 fixups: cache-dependency-glob updated to packages/*/uv.lock, uv sync/lint/test moved into per-package working-directory, ci.yaml path filters updated.\n\nRemaining for pnt-dre.4: replace setup-python/setup-uv actions with nix develop -c just \u003crecipe\u003e pattern, add justfile recipes for per-package sync/test/lint/typecheck, implement cached-ci-job composite action, dynamic package discovery.","created_at":"2026-02-02T20:17:02Z"}]}
{"id":"pnt-dre.5","title":"Add omnix template integration","description":"Configure om.templates in flake with parameter definitions. Add template-verify justfile recipe. Create .github/workflows/template.yaml for CI validation.","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T11:54:57.668262-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T15:56:15.624906-05:00","closed_at":"2026-02-02T15:56:15.624906-05:00","close_reason":"om.templates, template-verify recipe, and template.yaml workflow already existed. Fixed stale path-ignore filters for per-package lock pattern.","dependencies":[{"issue_id":"pnt-dre.5","depends_on_id":"pnt-dre","type":"parent-child","created_at":"2026-01-19T11:54:57.66888-05:00","created_by":"Cameron Smith"}]}
{"id":"pnt-edl","title":"Modernize nix module architecture and template validation","description":"Migrate python-nix-template to dendritic flake-parts architecture (import-tree) matching vanixiets, ironstar, and typescript-nix-template conventions. Fix template.yaml workflow to properly validate instantiated templates including PyO3/maturin extensions.\n\nMotivation: Current nix/modules/ uses hand-rolled readDir discovery instead of import-tree. Template CI test (test-omnix-template) fails because it runs nix develop -c pytest which cannot load PyO3 _native extension (maturin packages are excluded from editableOverlay by design). Both issues block PR #44 from being fully validated.\n\nReference implementations:\n- vanixiets: modules/ with import-tree, 200+ auto-discovered modules\n- ironstar: modules/ with import-tree, crane for Rust builds\n- typescript-nix-template: modules/ with import-tree, two-variant template testing\n\nSequencing: Migration first (structural), then template workflow fix (validation). Template test depends on knowing the final module layout.","status":"open","priority":2,"issue_type":"epic","owner":"cameron.ray.smith@gmail.com","created_at":"2026-02-03T10:09:57.390595-05:00","created_by":"Cameron Smith","updated_at":"2026-02-03T10:09:57.390595-05:00"}
{"id":"pnt-j6f","title":"Migrate to dendritic flake-parts with import-tree","description":"Restructure nix module architecture to match reference implementations (vanixiets, ironstar, typescript-nix-template).\n\nChanges required:\n- Add import-tree as flake input (github:vic/import-tree or equivalent)\n- Move nix/modules/*.nix to modules/*.nix (top-level)\n- Replace readDir-based discovery in flake.nix with: flake-parts.lib.mkFlake { inherit inputs; } (inputs.import-tree ./modules)\n- Add systems.nix module (extract system list from flake.nix)\n- Add flake-parts.nix module (external module imports like nix-unit)\n- Keep nix/packages/pnt-cli/ and nix/lib/ as non-module utilities (imported explicitly by python.nix)\n- Update all relative paths in modules that reference nix/packages/ or nix/lib/ (now one level up)\n- containers.nix is 355 lines — evaluate splitting into containers/dev.nix and containers/production.nix\n- Update template.nix conditional paths to reflect new module locations\n- Verify nix flake check passes after restructure\n- Update .github/workflows/ path filters if they reference nix/modules/\n\nKey architectural decisions:\n- Modules communicate through _module.args (python.nix exports) and config namespace (pre-commit.devShell)\n- import-tree auto-discovers all .nix files in modules/ tree\n- No manual imports list in flake.nix — adding a file to modules/ auto-includes it\n- nix/packages/ stays as explicit utility imports (not auto-discovered modules)","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-02-03T10:10:03.187287-05:00","created_by":"Cameron Smith","updated_at":"2026-02-03T11:07:43.74843-05:00","closed_at":"2026-02-03T11:07:43.74843-05:00","close_reason":"Implemented in b27f3c8. Dendritic migration, root pyproject.toml removal, ruff.toml, per-package justfile recipes, editable root fix.","dependencies":[{"issue_id":"pnt-j6f","depends_on_id":"pnt-edl","type":"child-of","created_at":"2026-02-03T10:10:17.67297-05:00","created_by":"Cameron Smith"}],"comments":[{"id":6,"issue_id":"pnt-j6f","author":"Cameron Smith","text":"Removing root pyproject.toml: vestigial workspace declaration contradicts federation model in python.nix","created_at":"2026-02-03T16:01:31Z"}]}
{"id":"pnt-m1w","title":"Fix template.yaml workflow for proper PyO3 and multi-variant validation","description":"Align template.yaml with typescript-nix-template patterns and fix the test-omnix-template job.\n\nRoot cause resolved (pnt-3qp): The PyO3 _native import failure was caused by pytest collecting tests from the source namespace, shadowing the installed wheel. Fixed by relocating pnt-cli tests to tests/ (outside src/). The editable overlay root was also fixed to use per-package paths ($REPO_ROOT/packages/\u003cname\u003e).\n\nRemaining work:\n- Replace nix develop -c pytest with nix flake check --accept-flake-config in template test\n- nix flake check exercises all Nix builds including maturin wheel, validating PyO3 integration\n- Add set-variables job (debug flags, skip-ci, checkout details)\n- Test TWO variants matching monorepo-package boolean parameter:\n  1. Full monorepo (monorepo-package=true): includes pnt-functional + pnt-cli\n  2. Single package (monorepo-package=false): main package only\n- Fix cachix reference: instantiated template tries pnt-mono.cachix.org which 401s (expected for fresh project, but should be parameterized or removed)\n- Consider adding lightweight smoke test after flake check: nix develop -c python -c 'import pnt_mono'\n- Root pyproject.toml has been removed; template assertion now checks ruff.toml\n- Per-package justfile recipes are now the standard pattern (test, lint, type take package parameter)\n\nReference: typescript-nix-template .github/workflows/template.yaml tests full and minimal variants with git init, bun install, nix flake check sequence.","status":"in_progress","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-02-03T10:10:08.916223-05:00","created_by":"Cameron Smith","updated_at":"2026-02-03T14:54:09.58158-05:00","dependencies":[{"issue_id":"pnt-m1w","depends_on_id":"pnt-edl","type":"child-of","created_at":"2026-02-03T10:10:17.838035-05:00","created_by":"Cameron Smith"},{"issue_id":"pnt-m1w","depends_on_id":"pnt-j6f","type":"blocked-by","created_at":"2026-02-03T10:10:18.005313-05:00","created_by":"Cameron Smith"},{"issue_id":"pnt-m1w","depends_on_id":"pnt-3qp","type":"blocked-by","created_at":"2026-02-03T10:20:21.254918-05:00","created_by":"Cameron Smith"}],"comments":[{"id":7,"issue_id":"pnt-m1w","author":"Cameron Smith","text":"Checkpoint: 2026-02-03 session\n\nDone:\n- Rewrote template.yaml aligned with typescript-nix-template pattern\n- Added set-variables job, cached-ci-job integration, workflow-level concurrency, force_run input\n- Replaced nix develop -c pytest with nix flake check + import smoke tests\n- Fixed per-package uv lock (federation model has no root pyproject.toml)\n- Disabled dev containers (catppuccin-starship build failure via nixpod) to unblock nix flake check\n- Archived dev container code to nix/disabled/containers-dev.nix.txt\n- Removed nixpod flake input and dev container justfile recipes\n\nRemaining:\n- CI run 21646259884 is in progress, needs to pass\n- If CI passes: close pnt-m1w and pnt-edl\n- If CI fails: debug and iterate\n\nCommits this session: 5eaab99..ee0295d (7 commits)","created_at":"2026-02-03T20:19:44Z"}]}
{"id":"pnt-m3t","title":"Adopt setup-nix composite action with nothing-but-nix pattern","description":"Port the vanixiets setup-nix composite action to python-nix-template, replacing inline Nix installation across all workflows.\n\nCurrent state:\n- ci.yaml, python-test.yaml, build-nix-images.yaml each inline DeterminateSystems/nix-installer-action\n- build-nix-images.yaml uses ad-hoc maximize-build-space shell script\n- scripts/ci/maximize-build-space.sh exists but is not wired into workflows\n\nTarget state (matching vanixiets):\n- .github/actions/setup-nix/action.yml composite action\n- Uses wimpysworld/nothing-but-nix for space reclamation (replaces maximize-build-space.sh)\n- Uses cachix/install-nix-action with pinned Nix version\n- Configures build-dir = /nix/build (nothing-but-nix workaround)\n- Integrates magic-nix-cache and cachix setup\n- Hatchet protocol support for configurable space levels\n- All workflows delegate Nix setup to this single action\n\nAcceptance criteria:\n- .github/actions/setup-nix/action.yml implemented (port from vanixiets)\n- ci.yaml nixci job uses setup-nix action\n- python-test.yaml uses setup-nix action\n- build-nix-images.yaml uses setup-nix action (replaces inline maximize-build-space)\n- .github/actions/build-nix-image/ updated (its Nix install steps replaced by setup-nix)\n- scripts/ci/maximize-build-space.sh removed (superseded by nothing-but-nix)\n- setup-python-uv action evaluated for removal (if all Python CI runs via nix develop)\n\nReference: ~/projects/nix-workspace/vanixiets/.github/actions/setup-nix/action.yml","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-02-02T20:24:06.14337-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T21:16:20.627824-05:00","closed_at":"2026-02-02T21:16:20.627824-05:00","close_reason":"Implemented in 0b1e4fa, setup-nix action ported from vanixiets"}
{"id":"pnt-mgq","title":"Migrate dev containers to nix2container via upgraded nixpod","description":"Update the dev container builds (containerImage, devcontainerImage) to use nix2container once nixpod itself has completed its nix2container migration.\n\nCurrent state:\n- nix/modules/containers.nix imports buildMultiUserNixImage from nixpod\n- nixpod uses dockerTools.buildLayeredImageWithNixDb internally\n- flocken handles multi-arch manifest creation for dev containers\n- Dev containers include multi-user Nix daemon, home-manager activation, s6-overlay\n\nBlocked on: nixpod completing its nix2container migration (refactor-container-builds branch has research docs with full API mapping and implementation plan)\n\nTarget state:\n- nixpod exports nix2container-based builders (buildMultiUserNixImage rewritten internally)\n- python-nix-template's dev containers consume upgraded nixpod\n- Dev container manifests use crane-based tooling (from pnt-5vr production container work)\n- s6-overlay, home-manager activation, multi-user Nix preserved in container content\n\nAcceptance criteria:\n- Dev containers build using nixpod's nix2container-based API\n- flocken fully removed from flake.nix (production containers handled by pnt-5vr)\n- No regression in dev container functionality (Jupyter, code-server, etc.)\n- Multi-arch publishing works via nix2container transport\n\nReference: ~/projects/nix-workspace/nixpod-home/docs/notes/development/container-build-refactoring.md\nReference: ~/projects/nix-workspace/nixpod-home/containers/nix.nix","status":"open","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-02-02T21:47:38.830624-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T21:47:38.830624-05:00"}
{"id":"pnt-wbq","title":"Add pkgsCross support for Python/maturin production containers","description":"Enable cross-compilation of production containers via pkgsCross, eliminating the need for per-architecture runners or QEMU emulation.\n\nCurrent state: production containers (nix2container) build natively per-system. On a single x86_64-linux CI runner, only x86_64 images are produced.\n\nTarget state: build both x86_64 and aarch64 production containers from a single x86_64-linux runner using pkgsCross, matching the vanixiets pattern.\n\nChallenge: the Python + maturin + Cargo build pipeline must work under cross-compilation. This requires:\n- Rust cross-compilation toolchain via pkgsCross (generally well-supported)\n- Python headers for target platform\n- maturin building wheels for the target platform\n- uv2nix virtual environment resolution for the target system\n\nThe nix2container infrastructure and containerMatrix are already in place (from pnt-5vr). This issue adds the pkgsCross target definitions and validates the cross-compilation pipeline.\n\nReference: vanixiets uses pkgsCross.gnu64 and pkgsCross.aarch64-multiplatform for simple nixpkgs packages. The Python/Rust case is more complex but the container infrastructure pattern is identical.","status":"open","priority":3,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-02-02T23:00:13.965286-05:00","created_by":"Cameron Smith","updated_at":"2026-02-02T23:00:27.262969-05:00","dependencies":[{"issue_id":"pnt-wbq","depends_on_id":"pnt-5vr","type":"discovered-from","created_at":"2026-02-02T23:00:28.588784-05:00","created_by":"Cameron Smith"}]}
