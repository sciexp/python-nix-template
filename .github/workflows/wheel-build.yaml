name: Wheel Build

on:
  workflow_dispatch:
    inputs:
      checkout-ref:
        description: "Git ref to checkout (default: triggering ref)"
        required: false
        type: string
        default: ""
  workflow_call:
    inputs:
      checkout-ref:
        description: "Git ref to checkout (default: triggering ref)"
        required: false
        type: string
        default: ""

# Template customization: update these for your package
env:
  PACKAGE_PATH: packages/pnt-cli

defaults:
  run:
    shell: bash

jobs:
  sdist:
    name: Build sdist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout-ref || github.ref }}
      - uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
          working-directory: ${{ env.PACKAGE_PATH }}
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: ${{ env.PACKAGE_PATH }}/dist/*.tar.gz

  build:
    name: Build wheel - ${{ matrix.platform }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-x86_64
            runner: ubuntu-latest
            target: x86_64
          - platform: linux-aarch64
            runner: ubuntu-24.04-arm
            target: aarch64
          - platform: macos-x86_64
            runner: macos-15-intel
            target: x86_64-apple-darwin
          - platform: macos-aarch64
            runner: macos-15
            target: aarch64-apple-darwin
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout-ref || github.ref }}
      - uses: actions/setup-python@v5
        with:
          python-version: |
            3.11
            3.12
      - uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i python3.11 python3.12
          manylinux: auto
          working-directory: ${{ env.PACKAGE_PATH }}
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.platform }}
          path: ${{ env.PACKAGE_PATH }}/dist/*.whl
